"use strict";angular.module("stemApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ui.bootstrap","ui.sortable","ui.utils"],["$compileProvider",function(a){a.aHrefSanitizationWhitelist(/^\s*(mailto|tel|sms|gtalk||):/)}]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]);var refreshInterval=5e3;angular.module("stemApp").controller("MainCtrl",["$scope","$filter","Site",function(a,b,c){angular.extend(a,{my:function(){c.my.get().$promise.then(function(b){a.my=(b||[])[0]})}(),users:function(){c.users.get().$promise.then(function(b){a.users=b})}(),stems:function(){return a.$watch("stems",function(a,b){null!==a&&angular.isDefined(a)&&a!==b&&(localStorage.stems=angular.toJson(a))},!0),a.stems=angular.fromJson(localStorage.stems||[]),function b(){a.stems.length&&c.stems.get({UserIDs:a.stems.reduce(function(a,b){return{UserID:[a.UserID,b.UserID].join(",")}}).UserID}).$promise.then(function(b){(b||[]).forEach(function(b){a.stems.forEach(function(c){c.UserID===b.UserID&&$.extend(c,a.stemInit(b))})})}),setTimeout(b,refreshInterval)}(),a.stems}(),stemInit:function(a){return $.extend(a,{KeyscanFromNow:moment(a.KeyscanUpdated).fromNow(),KeyscanStamp:moment(a.KeyscanUpdated).format("llll"),PhotoPath:a.PhotoPath?~a.PhotoPath.indexOf(c.url)?a.PhotoPath:c.url+a.PhotoPath:function(){c.photo.get({UserIDs:a.UserID}).$promise.then(function(b){a.PhotoPath=c.url+b[0].PhotoPath})}()})},stemAdd:function(c){b("filter")(a.stems,{UserID:c.UserID}).length||a.stems.push(a.stemInit(c))},stemRemove:function(b){a.stems.splice(b,1)},stemUpdate:function(b){b.preventDefault();var c=$(b.target).closest("user"),d=~[8,37,38].indexOf(b.keyCode)?"prev":"next";c[d]().focus(),~[8,46,void 0].indexOf(b.keyCode)&&(a.stemRemove(c.index()),c.addClass(d+"-"+b.type))},stemView:localStorage.stemView||"grid",stemSort:{containment:"parent",cursor:"move",opacity:.75,revert:250,tolerance:"pointer","ui-floating":"auto"}})}]).factory("Site",["$resource",function(a){var b="http://genome.klick.com",c=function(c,d,e){return a(b+"/api"+c,d||{ForGrid:!0},{get:angular.extend("function"==typeof e?{transformResponse:e}:e||{},{method:"JSONP",params:{format:"json",callback:"JSON_CALLBACK"},interceptor:{response:function(a){return a.data.Entries},responseError:function(a){~[0,401,403].indexOf(a.status)&&(location.href=b+"login/?t="+encodeURIComponent(location.href))}}})})};return{url:b,my:c("/user/current"),tasks:c("/ticket"),users:c("/user"),stems:c("/user",{UserIDs:"@UserIDs"}),photo:c("/user/photo",{UserIDs:"@UserIDs"})}}]);